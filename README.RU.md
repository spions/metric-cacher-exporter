# Metric Cacher Exporter

`metric-cacher-exporter` — это прокси-сервис для кэширования метрик в формате Prometheus.
Он предназначен для снижения нагрузки на системы и сервисы мониторинга путем кэширования дублирующих запросов в Redis.

## Пример использования:

Для отказоустойчивости зонального VMStack применяют шардирование или репликацию.

Шардированный режим работы VMAgent не обеспечивает полноценной отказоустойчивости, так как при падении одной
шарды (пода) в зоне данные от таргетов, которые эта шарда обрабатывала - потеряются.

Перевод VMAgent в режим репликации, например 2 и более реплик (как правило, ставят по количеству зон доступности),
приводит:
- увеличению запросов на истоник метрик, на котором может стоять лимит по запросам
- увеличению стоимости обслуживания, если метрики платные
- возможным поломкам графиков, там где не учтено возможное смещение времени опроса

Указанные проблемы решает `metric-cacher-exporter`.
Подтвержденная экономия составила порядка 70-80% на итоговой стоимости услуги сбора метрик.


## Основные возможности

- **Кэширование метрик**: Сохраняет ответы от апстрим-сервисов в Redis.
- **Гибкая настройка TTL**: Время жизни кэша задается для каждого запроса через параметр `cacheTTL`.
- **Дедупликация запросов**: Если несколько запросов приходят одновременно за одними и теми же данными, только один запрос уйдет на апстрим, остальные будут ждать результата.
- **Простая интеграция**: В случае использования VictoriaMetrics или Prometheus нужно добавить несоколько строк в `relabel_configs` не меняя основной запрос.


## Установка и использование:

По умолчанию `metric-cacher-exporter` слушает HTTP-порт 8080.

```Bash
docker run -d \
  --name metric-cacher-exporter \
  -p 8080:8080 \
  -e REDIS_ADDR=redis:6379 \
  spions/metric-cacher-exporter:latest
```

## Использование

Сервис работает как прокси. Вы передаете целевой адрес (upstream) в параметре `target`.

### Пример запроса:
```
http://localhost:8080/metrics?target=http://my-service:9090/metrics&cacheTTL=30
```

### Параметры запроса:
- `target`: URL или адрес хоста, с которого нужно забрать метрики.
- `cacheTTL`: (Опционально) Время жизни кэша в секундах. По умолчанию: 60.

## Конфигурация

Сервис настраивается через флаги командной строки или переменные окружения.

| Флаг | Переменная окружения | Описание | По умолчанию |
|------|----------------------|----------|--------------|
| `--redis.addr` | `REDIS_ADDR` | Адрес Redis сервера | `localhost:6379` |
| `--redis.password` | `REDIS_PASSWORD` | Пароль для Redis | `""` |
| `--redis.db` | `REDIS_DB` | Номер базы данных Redis | `0` |
| `--web.listen-address` | (нет) | Адрес и порт, на котором будет слушать сервис | `:8080` |

## Метрики сервиса

Сервис предоставляет собственные метрики на эндпоинте `/metrics`:

- `mce_http_requests_total`: Общее количество запросов (с разделением по `upstream`, `status` и `cache_status`).
- `mce_cacher_exported_metrics_lines_total`: Общее количество строк метрик, прошедших через кэшер.
- `mce_cache_error_total`: Счетчик ошибок при работе с кэшем.

## Пример интеграции с VictoriaMetrics / Prometheus

В конфигурации scrape config используйте `relabelConfigs` для перенаправления запросов через кэшер:

```yaml VictoriaMetrics
spec:
  path: "/metrics"
  scrape_interval: 60s
  params:
    cacheTTL: 
      - "45"
  staticConfigs:
    - targets: ["my-service:9090"]
  relabelConfigs:
    - source_labels: [__address__]
      target_label: __param_target
    - source_labels: [__param_target]
      target_label: instance
    - target_label: __address__
      replacement: metric-cacher-exporter:8080
```
